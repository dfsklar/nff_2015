$(function() {

  window.TRENDATA_oppexp = [{"data": {"node": {"count": 19387, "total_count": 19845, "label": "Number of Responses", "perc": 0.9769211388259007}, "children": [

{"node": {"count": 986, "perc": 0.050858822922576985, "question_key": "year", "label": "2009", "key": "2009", "order": "1"}, "children": 

[
{"node": {"count": 146, "perc": 0.14807302231237324, "question_key": "opp_exp", "label": "$0 - 250K", "key": "0_250", "order": "1"}}, {"node": {"count": 127, "perc": 0.12880324543610547, "question_key": "opp_exp", "label": "$250K - 500K", "key": "250_500", "order": "2"}}, {"node": {"count": 345, "perc": 0.34989858012170383, "question_key": "opp_exp", "label": "$500K - $2M", "key": "500_2000", "order": "3"}}, {"node": {"count": 162, "perc": 0.1643002028397566, "question_key": "opp_exp", "label": "$2M - $5M", "key": "2000_5000", "order": "4"}}, {"node": {"count": 84, "perc": 0.08519269776876268, "question_key": "opp_exp", "label": "$5M - $10M", "key": "5000_10000", "order": "5"}}, {"node": {"count": 54, "perc": 0.05476673427991886, "question_key": "opp_exp", "label": "$10M - 20M", "key": "10000_20000", "order": "6"}}, {"node": {"count": 68, "perc": 0.06896551724137931, "question_key": "opp_exp", "label": "Greater than $20M", "key": ">_20000", "order": "7"}}]}, 



{"node": {"count": 1315, "perc": 0.06782895754887296, "question_key": "year", "label": "2010", "key": "2010", "order": "2"}, 
"children": [

{"node": {"count": 326, "perc": 0.2479087452471483, "question_key": "opp_exp", "label": "$0 - 250K", "key": "0_250", "order": "1"}}, {"node": {"count": 177, "perc": 0.13460076045627375, "question_key": "opp_exp", "label": "$250K - 500K", "key": "250_500", "order": "2"}}, {"node": {"count": 397, "perc": 0.30190114068441065, "question_key": "opp_exp", "label": "$500K - $2M", "key": "500_2000", "order": "3"}}, {"node": {"count": 158, "perc": 0.12015209125475285, "question_key": "opp_exp", "label": "$2M - $5M", "key": "2000_5000", "order": "4"}}, {"node": {"count": 107, "perc": 0.08136882129277566, "question_key": "opp_exp", "label": "$5M - $10M", "key": "5000_10000", "order": "5"}}, {"node": {"count": 74, "perc": 0.05627376425855513, "question_key": "opp_exp", "label": "$10M - 20M", "key": "10000_20000", "order": "6"}}, {"node": {"count": 76, "perc": 0.05779467680608365, "question_key": "opp_exp", "label": "Greater than $20M", "key": ">_20000", "order": "7"}}]}, 




{"node": {"count": 1904, "perc": 0.09821014081601073, "question_key": "year", "label": "2011", "key": "2011", "order": "3"}, "children": [

{"node": {"count": 333, "perc": 0.17489495798319327, "question_key": "opp_exp", "label": "$0 - 250K", "key": "0_250", "order": "1"}}, {"node": {"count": 242, "perc": 0.12710084033613445, "question_key": "opp_exp", "label": "$250K - 500K", "key": "250_500", "order": "2"}}, {"node": {"count": 636, "perc": 0.33403361344537813, "question_key": "opp_exp", "label": "$500K - $2M", "key": "500_2000", "order": "3"}}, {"node": {"count": 309, "perc": 0.16228991596638656, "question_key": "opp_exp", "label": "$2M - $5M", "key": "2000_5000", "order": "4"}}, {"node": {"count": 176, "perc": 0.09243697478991597, "question_key": "opp_exp", "label": "$5M - $10M", "key": "5000_10000", "order": "5"}}, {"node": {"count": 102, "perc": 0.05357142857142857, "question_key": "opp_exp", "label": "$10M - 20M", "key": "10000_20000", "order": "6"}}, {"node": {"count": 106, "perc": 0.05567226890756303, "question_key": "opp_exp", "label": "Greater than $20M", "key": ">_20000", "order": "7"}}]}, 





{"node": {"count": 4590, "perc": 0.2367565894671687, "question_key": "year", "label": "2012", "key": "2012", "order": "4"}, "children": [
{"node": {"count": 917, "perc": 0.19978213507625273, "question_key": "opp_exp", "label": "$0 - 250K", "key": "0_250", "order": "1"}}, {"node": {"count": 592, "perc": 0.1289760348583878, "question_key": "opp_exp", "label": "$250K - 500K", "key": "250_500", "order": "2"}}, {"node": {"count": 1489, "perc": 0.324400871459695, "question_key": "opp_exp", "label": "$500K - $2M", "key": "500_2000", "order": "3"}}, {"node": {"count": 726, "perc": 0.15816993464052287, "question_key": "opp_exp", "label": "$2M - $5M", "key": "2000_5000", "order": "4"}}, {"node": {"count": 365, "perc": 0.07952069716775599, "question_key": "opp_exp", "label": "$5M - $10M", "key": "5000_10000", "order": "5"}}, {"node": {"count": 264, "perc": 0.05751633986928104, "question_key": "opp_exp", "label": "$10M - 20M", "key": "10000_20000", "order": "6"}}, {"node": {"count": 237, "perc": 0.05163398692810457, "question_key": "opp_exp", "label": "Greater than $20M", "key": ">_20000", "order": "7"}}]}, 




// 2013 survey (which is FY2012)
{"node": {"count": 5573, "perc": 0.2874606695208129, "question_key": "year", "label": "2013", "key": "2013", "order": "5"}, 
 "children": [
   {"node": {"count": 1300, "perc": 0.23326753992463664, "question_key": "opp_exp", "label": "$0 - 250K", "key": "0_250", "order": "1"}}, 
   {"node": {"count": 650, "perc": 0.11663376996231832, "question_key": "opp_exp", "label": "$250K - 500K", "key": "250_500", "order": "2"}},
   {"node": {"count": 1789, "perc": 0.3210120222501346, "question_key": "opp_exp", "label": "$500K - $2M", "key": "500_2000", "order": "3"}}, {"node": {"count": 954, "perc": 0.17118248699084873, "question_key": "opp_exp", "label": "$2M - $5M", "key": "2000_5000", "order": "4"}}, {"node": {"count": 522, "perc": 0.09366588910820026, "question_key": "opp_exp", "label": "$5M - $10M", "key": "5000_10000", "order": "5"}}, {"node": {"count": 358, "perc": 0.06423829176386148, "question_key": "opp_exp", "label": "$10M - 20M", "key": "10000_20000", "order": "6"}}, {"node": {"count": 0, "perc": 0.0, "question_key": "opp_exp", "label": "Greater than $20M", "key": ">_20000", "order": "7"}}]}, {"node": {"count": 5019, "perc": 0.2588848197245577, "question_key": "year", "label": "2014", "key": "2014", "order": "6"}, "children": [{"node": {"count": 792, "perc": 0.15780035863717873, "question_key": "opp_exp", "label": "$0 - 250K", "key": "0_250", "order": "1"}}, {"node": {"count": 489, "perc": 0.09742976688583384, "question_key": "opp_exp", "label": "$250K - 500K", "key": "250_500", "order": "2"}}, {"node": {"count": 1466, "perc": 0.29209005778043434, "question_key": "opp_exp", "label": "$500K - $2M", "key": "500_2000", "order": "3"}}, {"node": {"count": 963, "perc": 0.19187089061566048, "question_key": "opp_exp", "label": "$2M - $5M", "key": "2000_5000", "order": "4"}}, {"node": {"count": 512, "perc": 0.10201235305837816, "question_key": "opp_exp", "label": "$5M - $10M", "key": "5000_10000", "order": "5"}}, {"node": {"count": 345, "perc": 0.06873879258816497, "question_key": "opp_exp", "label": "$10M - 20M", "key": "10000_20000", "order": "6"}}, {"node": {"count": 452, "perc": 0.09005778043434948, "question_key": "opp_exp", "label": "Greater than $20M", "key": ">_20000", "order": "7"}}]}]}, "id": "year/opp_exp"}];




  var chartspec = 
      {
        legend: { enabled: true },
        credits: { enabled: false },
        chart: {
          type: 'column',
          spacingLeft: 0, spacingRight: 0, marginRight: 0, spacingBottom: 10
        },
        title: {
          text: ''
        },
        subtitle: {
          text: ''
        },
        xAxis: {
          categories: [ 
            // HERE I AM GOING TO STORE THE ACTUAL DOLLAR-RANGE VALUES, ready for display
          ]
        },
        yAxis: {
          min: 0,
          title: {
            text: 'Percentage'
          }
        },
        tooltip: {
          headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
          pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
            '<td style="padding:0"><b>{point.y:.0f}%</b></td></tr>',
          footerFormat: '</table>',
          shared: true,
          useHTML: true
        },
        plotOptions: {
          column: {
            pointPadding: 0.2,
            borderWidth: 0
          }
        },
        series: [ ]
        /*
          {
          name: 'Tokyo',  // THIS WILL ACTUALLY BE A YEAR
          data: [49.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5, 216.4, 194.1, 95.6, 54.4]
          
          }, {
          name: 'New York',
          data: [83.6, 78.8, 98.5, 93.4, 106.0, 84.5, 105.0, 104.3, 91.2, 83.5, 106.6, 92.3]
          
          }, {
          name: 'London',
          data: [48.9, 38.8, 39.3, 41.4, 47.0, 48.3, 59.0, 59.6, 52.4, 65.2, 59.3, 51.2]
          
          }, {
          name: 'Berlin',
          data: [42.4, 33.2, 34.5, 39.7, 52.6, 75.5, 57.4, 60.4, 47.6, 39.1, 46.8, 51.1]
          
          }]
        */
      };

  var DB = window.TRENDATA_oppexp[0];

  var colorRange = chroma.scale([chroma("#e2e3de"), window.nfforg.colors.Blue2]);

  var idx = 0;

  DB.data.children.each(function(YEAR){
    idx++;
    var year = YEAR.node.key;  // "2009"
    var thisSeries = { name: year, color: colorRange(idx/DB.data.children.length).hex(), data: [] };
    YEAR.children.each(function(DATAPOINT){
      thisSeries.data.add(Math.round(100*DATAPOINT.node.perc));
    });
    chartspec.series.add(thisSeries);
  });

  // We'll just grab the categories from the 0th year
  DB.data.children[0].children.each(function(RANGESPEC){
    chartspec.xAxis.categories.add(RANGESPEC.node.label.replace("Greater than",">"));
  });


  Highcharts.setOptions({
    chart: {
      animation: false,
      backgroundColor: "white",
      style: {
        fontFamily: 'Arial', //(options.stdfont ? 'Arial' : 'Roboto Condensed'),
        fontSize: "12px" // (options.hires ? "20px" : "10px")
      }
    }
  });

  $('.chart').highcharts(chartspec);

});
